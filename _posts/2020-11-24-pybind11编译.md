---
layout:     post   				    
title:      Python调用C++				
subtitle:   基于pybind11实现Python调用C++编写的算法(Linux+Cmake)
date:       2020-11-24 				
author:     WarmStar 						
header-img: img/blog5.jpg	
catalog: true 				
tags:							
    - DL
---

> Ubuntu 18.04
>
> python 3.6
>
> pybind11

### pybind11

`Python`作为解释型语言，虽然纵享丝滑，但是速度慢的特点也被诟病已久，老大哥`C++`的速度是`Python`这辈子都无法比肩的，如果`Python`项目中出现了一个会产生庞大计算量的函数，且该函数会被多次调用，那么无疑会拖慢项目速度，这时候可以架设`pybind11`作为 `C++`和`Python`之间沟通的桥梁。

`pybind11` 是一个轻量级的只包含头文件的库，用于`Python`和`C++`之间接口转换，可以为现有的`C++`代码创建`Python`接口绑定。具体的原理我太懂，简单说就是可以把`C++`编写好的算法代码先这样一下再那样一下，然后就可以直接使用`Python`调用了，这样既可以保持丝滑又可以加快速度 ｸﾞｯ!(๑•̀ㅂ•́) ✧



##### 1. 安装pytest

````python
pip install pytest
````

##### 2. 下载pybind11

`example.cpp`是写好的`c++`算法文件，在该文件相同目录下载`pybind11`源码。

```python
git clone https://github.com/pybind/pybind11.git
```



![Markdown](http://i2.tiimg.com/730017/126a1a8c68063365.jpg)

##### 3. C++文件添加pybind11入口

`c++`文件末尾需添加如图所示的入口代码，`PYBIND11_MODULE`这里变量名要和`c++`文件同名，`add_arrays_2d`是该`c++`写的函数的名称。

![Markdown](http://i2.tiimg.com/730017/5e7cee5510ae8693.png)

##### 4. 编译安装pybind11

```python
cd pybind11
mkdir build
cd build
cmake ..
cmake --build . --config Release --target check
```

![Markdown](http://i2.tiimg.com/730017/23a6dddce289ffa2.png)

![Markdown](http://i2.tiimg.com/730017/2ee6dceaac7477ca.png)

![Markdown](http://i2.tiimg.com/730017/fcf236e44b9211e3.png)



##### 5. 最简单的编译方式

在`Linux`上编译，可以选择最简单的`gcc`方式。

```
c++ -O3 -Wall -shared -std=c++11 -fPIC `python3 -m pybind11 --includes` example.cpp -o example`python3-config --extension-suffix`
```



##### 6. 使用cmake编译

使用`cmake`创建工程，编译为动态库，然后使用`python`调用。

​	6.1 首先需要写一个`CMakeLists.txt`，注意括号内的值的写法。

![Markdown](http://i2.tiimg.com/730017/48aa609ab5a80670.png)

​	6.2 这里要求`example.cpp`和`pybind11`放在相同目录下，因为在`CMakeLists.txt`中调用了同目录的`pybind11`和`example.cpp`文件。

![Markdown](http://i1.fuimg.com/730017/2b9bf34957a62969.png)

​		然后直接在当前目录下执行:

```python
cmake .
make
```

![Markdown](http://i2.tiimg.com/730017/3654b2cec4e45bc8.png)

​	6.3 最终生成如下`.so`文件，该文件可以重命名，例如改成`example.so`。

![Markdown](http://i2.tiimg.com/730017/02973b93887f60b3.png)

​	6.4 至此可以直接使用`Python`直接调用`example.so`。

![Markdown](http://i2.tiimg.com/730017/855c810adf707d19.png)







