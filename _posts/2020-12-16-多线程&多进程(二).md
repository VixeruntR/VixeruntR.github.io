---
layout:     post   				    
title:      Python多线程与多进程(二) 				
subtitle:   
date:       2020-12-16 				
author:     WarmStar 						
header-img: img/blog8.jpg 	
catalog: true 				
tags:							
    - Python
---

> Python3.2之后的版本里，concurrent.futures模块新增了ThreadPoolExecutor(线程池)和ProcessPoolExecutor(进程池)，可以更方便的创建多线程和多进程。

## 重要概念

首先补充几个重要的概念：

##### 并发执行&并行执行

+ 并发：指的是多个事情，在同一**时间段内**同时发生了。
+ 并行：指的是多个事情，在同一**时间点上**同时发生了。只有多核的CPU才会发生并行。

举个例子：并发就像一个人在给盆栽浇水，他的只有一个水壶，于是他一会给仙人掌浇水一会给绿萝浇水，交替进行直到浇水完毕；并行就像他拿着两个水壶，同时给仙人掌和绿萝浇水直到浇水完毕。

##### 同步调用&异步调用

+ 同步调用：提交任务，原地等待任务执行结束，拿到任务返回结果，再执行下一行代码，任务串行执行。
+ 异步调用：提交任务，不进行原地等待，直接执行下一行代码，任务并发执行。

##### 阻塞状态&非阻塞状态

- 阻塞：程序遇到IO操作时，进行原地等待，即程序处于阻塞态。
- 非阻塞：程序没有进行IO操作时，程序处于运行态，即就绪态。

<br/>

## ThreadPoolExecutor

利用`ThreadPoolExecutor`可以很方便的创建线程池，使用方法一般是调用`map`或者`submit + as_completed`。推荐使用`with`关键字开启线程池，否则还需要添加`shutdown()`关闭线程池，而`with`内部已经实现了`wait()`，可以自动关闭线程池。

##### map

> 语法:&nbsp;&nbsp;executor.map(fn, *iterables)
>
> fn:&nbsp;&nbsp;函数名
>
> iterables:&nbsp;&nbsp;可迭代对象，可以是列表/元组等，有几组可迭代对象fn函数就要有几个参数

```python
from concurrent.futures import ThreadPoolExecutor

def run(bases, powers):
    print("current base:", bases)
    print("current power:", powers)
    return bases ** powers

with ThreadPoolExecutor(max_workers=4) as executor:
    result = executor.map(run, [1, 2, 3, 4], [2, 5, 3, 2])
print(list(result))
```

输出结果：

```python
current base: 1
current power: 2
current base: 2
current power: 5
current base: 3
current power: 3
current base: 4
current power: 2
[1, 32, 27, 16]
```

##### submit + as_completed

> 语法:&nbsp;&nbsp;executor.submit(fn, *args)
>
> fn:&nbsp;&nbsp;函数名
>
> args:&nbsp;&nbsp;任意类型的参数

```python
from concurrent.futures import ThreadPoolExecutor, as_completed

def run(base, power):
    print("current base:", base)
    print("current power:", power)
    return base ** power

future_list = []
with ThreadPoolExecutor(max_workers=4) as executor:
    for i in range(4):
        future = executor.submit(run, i + 1, i * 2)
        future_list.append(future)

for res in as_completed(future_list):
    print(res.result())
```

输出结果：

```python
current base: 1
current power: 0
current base: 2
current power: 2
current base: 3
current power: 4
current base: 4
current power: 6
4096
1
81
4
```

##### 不使用with

这里不使用`with`关键字开启线程池，则需要使用`shutdown()`手动关闭。

```python
from concurrent.futures import ThreadPoolExecutor, as_completed

def run(list1, list2):
    return sum(list1) + sum(list2)

future_list = []
executor = ThreadPoolExecutor(max_workers=4)
for i in range(4):
    future = executor.submit(run, [i, 1, 2, 3], [i * 2, 2, 5, 6])
    future_list.append(future)
executor.shutdown()

for res in as_completed(future_list):
    print(res.result())
```

输出结果：

```python
19
28
25
22
```

